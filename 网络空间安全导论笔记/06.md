# 第七章 网络攻击阻断



## 一、防火墙



### 1、原理

防火墙是一种特殊的访问控制工具，用于网络边界，根据预定义的策略限制通过它的数据

![image-20191127003752879](C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191127003752879.png)



### 2、防火墙的类型

- **IP防火墙—第三层**
  
  - 又称为报文过滤(Packet filter)防火墙
  - 报文过滤只能根据IP地址和端口号，无法针对特定用户或特定的服务请求
- IP数据包可直接在内部和外部主机之间访问
  
- **应用层防火墙—第7层**

  - 又称代理(proxy)防火墙

  - 使用代理桥接跨网络边界的连接

  - 客户端与服务器之间没有直接的数据包交换

  - 致力于特定的应用

  - 分为两类：

    - 状态检测防火墙

      IP级防火墙的基础上加上高层协议报头的内容检查

    - 另一种以SSH服务器提供的端口转发功能为代表

- **链路级防火墙**
  - 数据传输路径保护服务，例如：VPN
  - 不针对专门的应用协议，，而是一种通用的TCP(UDP)中继服务

- **Web应用程序防火墙**
  - HTTP应用程序的应用程序防火墙
  - 它对HTTP会话应用了一组规则，来提供入侵监测、负载平衡和改进的交付服务的集成



### 3、防火墙的实现方式

- **网络设备中的软件模块**
  - ACL功能

- **主机中的软件工具**
  - 代理
  - 个人防火墙

- **独立设备**
  - 基于切换台
  - 在数据包级别和应用程序级别进行过滤



### 4、IP级防火墙

一个多端口的交换设备，它对每一个到来的报文根据报头进行过滤，按一组预定义的规则来判定该报文是否可以继续转发，报文之间不存在上下文关系



#### 基本概念

- 入口流量：数据包从外部网络到达网络边界
- 出口流量：数据包从网络边界流向外部网络
- 内向数据包：源地址位于外部，目标地址位于内部
- 外向数据包：源地址位于内部，目标地址位于外部
- 内向服务：请求外向，响应内向
- 外向服务：请求是内向的，响应是外向的



#### 过滤规则

基于安全策略：什么样的流量是允许和不允许的

- 规则取决于：
  1. 根据报头的内容定义
  2. 区分入口流量和出口流量
  3. 指示条件满足时的动作
  4. 应指定默认动作
- 规则定义为有序集，并在用于数据包筛选之前先解释为内部数据结构



#### IP级防火墙技术的特点

- IP级防火墙对信道中的所有IP报文按预定义的策略进行过滤，这种安全检查功能对端系统不产生额外的开销
- 防火墙对于IP报文的处理对于端系统而言是透明的
- IP级防火墙会增加网络的传输时延，但对端系统的处理性能没有影响
- **局限性**
  - 过滤规则的制定收被保护对象共同需求的限制，因此是他们的交集(最小保护)，不适合在用户需求不一致的公网设立
  - IP级防火墙无法防范针对过滤规则的的欺骗行为。
  - IP级防火墙不适用存在NAT的网络环境，因为过滤规则是基于IP地址或其范围来定义的



#### Example in Linux

- Netfilter：过滤程序

- iptables：规则集管理

  <img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191127010539960.png" alt="image-20191127010539960" style="zoom: 80%;" />

  - Chain：INPUT、OUTPUT、FORWARD
  - Command：Append、Delete、Policy

<img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191127010814649.png" alt="image-20191127010814649" style="zoom:67%;" />



### 5、状态防火墙

不仅检查IP数据包报头，还检查更高层的包头，并且提供更多的上下文消息进行过滤。

- 以TCP连接或者UDP流作为过滤单位，不满足通过条件的连接的全部报文都将被拦截
- 更多存储：再过滤过程中维护状态表
- 更少的处理：规则集仅用于流的第一个数据包
- 可能进行更深层的过滤：例如寻找病毒

<img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191127011522373.png" alt="image-20191127011522373" style="zoom:80%;" />

- 6是IP报头中的协议类型字段内容，表示TCP
- 93、41294是该表项的剩余时间，超过将清楚
- SYN_SENT是TCP当前的连接状态



### 6、Web应用防火墙

WBE应用防火墙WAF是集Web防护，网页保护，负载均衡，应用交付等多种功能于一体的Web整体安全防护设备，主要用于门户网站等



#### WAF的功能

- **纵深安全防御功能**

  - 是指从网络访问能力、网络访问内容、网络访问过程的各个方面来实施的网络安全检查与攻击防御

  - 网络访问能力：对协议端口的开发程度进行检查，包括对ARP交互的可信性检查
  - 网络访问内容：包括对协议交互规范性的检查
  - 网络访问过程：根据日志内容进行用户访问行为的长期跟踪，重点是威胁源的发现和跟踪

- **快速应用交付功能**

  - 指WAF在处理用户的web访问交互过程中实施的性能优化措施

- **运行监控与服务发现功能**
- 服务发现：是指WAF可以通过用户的访问来自动发现被保护的Web服务器中存在的资源，实现自动的配置管理，而不需要手工定义被保护的对象，提高配置管理的可靠性
  - 运行监控：WAF运行监控包括安全监控和性能监控两个方面



### 7、防火墙的使用



#### 路由器过滤方式的防火墙

- 在内部边界网路由器中使用ACL功能(IP报文过滤功能)
- 又称为带孔防火墙，这是因为为了使被防火墙保护的网络也能提供服务器端的通信，需要在防火墙中开放某些端口以接受服务器的请求。开放端口就相当于在防火墙中打孔

<img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191127012151200.png" alt="image-20191127012151200" style="zoom:67%;" />



#### 主机过滤方式的防火墙

- 将网络中需要被外部访问的哪些服务放置在堡垒主机中，而那些不需要、不允许被外部访问的系统放在内部网中，从而方便过滤规则的设置

- 堡垒主机通常还与NAT技术结合使用，也可称为<u>无孔方法</u>

- 以IP级防火墙或状态防火墙作为网络边界的网关，通过对端口的控制，只允许内部用户以客户端的身份与外部通信，禁止外部向内的访问请求
- 外部可用的所有服务都位于堡垒主机中

<img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191127012432310.png" alt="image-20191127012432310" style="zoom:67%;" />



#### DMZ模式

- 内部防火墙无孔，而外部防火墙有孔
- DMZ是内部网与外部网络之间的一个服务器网段
- 外部网络中的用户可以访问这个网段，但是不能通过该网段去访问内部网络
- DMZ与外部网络连接的防火墙是开孔的，即允许特定的服务被外界访问
- DMZ与内部网络连接的防火墙是是只允许外出访问的，即是无孔的
- DMZ方法的核心思想是对不同网段可实施不同的安全政策和过滤政策

<img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191127012613099.png" alt="image-20191127012613099" style="zoom:67%;" />



#### 网关方法

- 主要适用于WAF
- WAF不适合在网络边界使用，而是部署在服务器段的边界

<img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191127012705678.png" alt="image-20191127012705678" style="zoom:67%;" />





## 二、会话拦截



### 1、基于传输层的会话拦截

- 通过在传输层插入伪造的TCP RST报文以终止会话达到会话拦截的效果
- TCP报头中的复位（RST）标志位用于异常拆链。通常用于拒绝TCP连接建立的情形和收到异常报文的情形
- 因为报文的传输路径不同会导致报文达到端点时的TTL和真实TTL值并不相符。一些软件可以根据TTL过滤异常的RST报文来逃逸拦截





### 2、基于DNS重定向的会话拦截

- 通过修改合法的DNS响应结果来达到服务拦截的目的

- 如果用户采用自己设置的DNS服务器或者在主机Hosts文件中静态定义域名和IP地址的映射关系，则DNS重定向技术会失效

- 进行DNS重定向的需求有两种
  - **屏蔽非法网站**

    通过伪造NXDOMAIN错误或者这些DNS的A记录解析成127.0.0.1这样的地址，用户不能获得有效地址就不能建立有效的连接继续访问过程，从而达到会话拦截的效果

  - **中间人服务器的地址**

    所有用户发往目标网站的请求都会经过这个中间服务器被转发，从而中间人服务器可以监控用户访问的内容

#### Example

![image-20191127195119189](C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191127195119189.png)



## 三、数字取证



### 1、基本概念



#### 计算机取证

- 一门获取、保存、恢复和递交经过电子处理和存储在计算机媒体中的数据的学科(FBI定义)

- 对存在于计算机及其相关的设备中的电子证据进行获取、保全、鉴别、分析和递交的过程，并且这一过程要能够被法律所认可，所获取的证据必须是真实的、准确的、完整的、符合法律规定的，可为法庭所接受的（综合定义）




#### 基本取证模型

- **基本过程模型(Basic Process Model,BPM)**

  - 现场安全保证及隔离
  - 记录现场信息
  - 系统的查找证据
  - 对证据进行提取和打包
  - 维护证据链

- **集成数字调查模型(the Integrated Digital Investigation,IDIM)**

  - 准备阶段
  - 部署阶段
  - 物理犯罪现场调查
  - 数字犯罪现场调查
  - 总结阶段

- **集成数字取证过程模型(Integrated digital forensic process model,IDFPM)**

  - 顺序过程
    - 取证准备
    - 事件发现
    - 事件响应
    - 数字取证调查
    - 陈述决策
  - 文档编制过程

  ![image-20191127200100196](C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191127200100196.png)



#### 计算机取证的操作原则

- 及时性
- 原始性
- 专业性
- 完整性



### 2、计算机取证技术的分类

- **识别类(Identification)**
  - 识别可获取的信息的类型以及获取的方法
  - 事件/犯罪检测、签名处理、配置检测、异常检测、系统监视、审计分析等

- **保存类(preservation)**
  - 保证证据状态的完整性，确保跟原始数据一致，不对原始数据造成改动和破坏
  - 镜像技术、数据加密、数字签名、数据摘录、证据保管链

- **收集类(collection)**
  - 提取或捕获突发事件的相关记录及其属性(或特征)
  - 合适的复制软件、无损压缩、数据恢复技术

- **检查类(Examination)**
  - 对事件的相关记录及其属性进行所需的检查
  - 追踪、过滤技术、模式匹配、隐藏技术发现以及隐藏数据提取

- **分析类(analysis)**
  - 为了获得结论而对数字证据进行融合、关联和同化
  - 追踪、统计分析、协议分析、数据挖掘、时间链分析以及关联分析等

- **呈堂类(presentation)**
- 使得可以客观、有条不紊、清晰、准确地报告事实
  
- **工控设备取证**

- **云计算环境取证**
- **移动设备取证**



### 3、计算机取证的一般操作流程

- 取证环境的准备过程
- 取证工具的准备

- 活动系统中的证据采集过程
- 数据分析过程



### 4、黑色郁金香

基于IDFPM模型



#### DigiNotar的公钥证书处理流程

![image-20191127201458242](C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191127201458242.png)



#### 事件发现

DigiNotar于2011年6月和7月遭受破坏，导致发行了流氓证书，随后在2011年8月的大规模攻击中滥用了这些流氓证书。



#### 事件响应

- 2011年7月19日，DigiNotar意识到闯入事件
  在其常规证书签署审核期间。 发现并删除了一些流氓证书。
- 2011年8月29日至28日，Google收到了几份有关DigiNotar发行的流氓* .google.com证书的未遂SSL MITM攻击的报告。
- 2011年8月29日，GOVCERT.NL和Cert-Bund都将恶意证书事件通知了DigiNotar。
- 2011年8月30日，DigiNotar委托Fox-IT调查入侵。



#### Fox-IT的工作

- 在DigiNotar网络的边界安装了监IDS，以检查入侵是否仍在进行中
- 调查了所有系统以及Web服务器，CA服务器和防火墙的日志
  
  - 尝试恢复入侵者删除的数据
  - 创建了400个具有7TB压缩数据的取证磁盘
- 向荷兰国家提交调查报告
  - 向KLPD报告入侵者
  - 向公众报告



#### Web服务器的调查

- Portal服务器正在运行过时的DotNetNuke软件版本，这些漏洞成为DigiNotar网络的第一个入口。
- 安装了Webshell（setting.aspx）
  - 门户已被入侵者清除，该程序在其他CA服务器的缓存网页中找到
  - 工作目录：D：\ Websites \ DigiNotar.nl \ DigiNotarweb01 \ beurs
- DigiNotar的主Web服务器崩溃后，DigiNotar的一名员工发现了证据，表明Main-Web服务器已受到威胁。 使用旧的备份将新的Web服务器安装在其他硬件上，该文件将保留受感染Web服务器的数据（包括截至2011年8月1日的日志文件），以备进一步调查。

![image-20191127202618954](C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191127202618954.png)



#### 检查Windows IIS日志文件

查找与/ beurs连接的内部或外部系统，以及一旦存储在此目录下的文件

-  C：\ WINDOWS \ system32 \ LogFiles \ W3SVC1062701327 \
- C：\ Data \ Websites \ Logging \ W3SVC1062701327 \
- EX <YYMMDD> .log
- 对整个磁盘映像执行模式匹配文本搜索，以搜索包含/ beurs的日志条目。
- 找到1583个条目

![image-20191127202948203](C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191127202948203.png)



#### 检查防火墙日志

- 6月17号11点28分，出现了门户网站通过1433端口向位于后台网段BAPI-db(Microsoft SOL)服务器的连接，而这两个服务器在此之前从来没有过这样的连接

- 随后出现的类似连接表明攻击者在对那个MSSQL数据库进行扫描探测

- 通过对防火墙日志的搜索分析，调查组发现攻击者在6月17号攻入门户网站，7月1号攻入安全网段，7月22号完成整个攻击过程并撤离

- 攻击者攻击**DigiNotar**网络的防火墙日志统计

  ![image-20200104195329248](C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20200104195329248.png)

  表明攻击者在对不同网段进行入侵尝试

- 通过进一步分析，调查组发现攻击者在内部网段被攻破的主机中下载了隧道通信程序，在内部服务器端使用3389端口，在外部DMZ主机端使用443端口，实现这些主机间穿透防火墙的跨网段通信传输



#### CA服务器的调查

- CA服务器的调查对象是CA软件的日志，以及两个与公钥证书有关的数据库
- 通过对CA服务器日志的调查，调查组发现了DigiNotar密钥管理的安全漏洞。CRL生成的周期性使得私钥进入内存的时间可以被预测，进而使攻击者有机会利用内存中的私钥进行冒名公钥证书的签发
- 调查组的调查重点是Public-CA服务器的日志，这是DigiNotar的SSL证书服务器



#### 总结

- **漏洞**
  - 及时更新软件
  - 及时审核
  - 内部入侵检测
  - 安全程序
- **后果**
  - 不可撤销的流氓证书
  - CA被撤销