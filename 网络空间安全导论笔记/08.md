# 第九章 网络基础设施保护



## 一、网络基础设施保护



### 1、链路层的安全问题



#### 概述

- 网络协议报文的传输结构为串珠结构，网络安全交互的安全强度由报文串珠中安全性最弱的那个协议的安全强度决定

- 链路层是有语义的传输结构的最底层协议，广义含义，包括数据链路层和部分网络层的内容

- **广义链路层**

  - 功能由交换机提供
  - 基本任务
    1. 实现用户设备的物理接入
    2. 维持物理网的正确拓扑
  - 安全问题
    1. 用户接入和访问的信任问题
    2. 所提供服务的能力控制问题

- **用户接入的信任问题**

  鉴别请求接入的用户的真实性和合法性

- **用户访问的信任问题**

  从网络拓扑角度看，进行访问的用户确实是那个位置的用户

- **ARP欺骗攻击**

  攻击者将自己伪装成另一台主机或网关路由器，实现中间人攻击，拒绝服务攻击

- **DHCP欺骗**

  攻击者冒充DHCP服务器，以实现信息劫持和服务失效

- **服务能力控制问题**

  - CAM表溢出攻击

    设法用不同的MAC地址将CAM填满，迫使交换机进行泛洪转发，从而收到自己所在VLAN的全部数据帧

  - 服务失效攻击

    1. 攻击者可以伪装成客户端向服务器发送大量请求地址直至IP地址全部耗尽，使得进入网络的客户段无地址可用，达到拒绝服务的攻击
    2. 也可以发送大量ARP报文将本地的ARP表填满，使得整个物理网崩溃

​    

#### 链路层的安全需求

- 对于链路层的基本任务而言，相应的安全需求是提供对用户的鉴别、授权、计费(Authentication Authorization Accounting)，又称AAA

- **鉴别**

  确认进入网络的用户是否为合法用户

- **授权**

  对用户设备的可访问范围、可使用资源和协议类型进行限定

- **计费**

  本质上是一种审计服务

- **AAA结构**

  <img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191224201839262.png" alt="image-20191224201839262" style="zoom:50%;" />

  采用客户端/服务器结构,客户端运行在NAS上，负责验证用户的身份和管理用户的接入并将鉴别、授权、计费信息转交给管理服务器，服务器集中管理用户信息

- **AAA协议**

  最常用的有RADIUS(remote Authentication Dial-in User Service，远程认证拨号用户服务)





### 2、链路层认证协议



#### RADIUS

<img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191224203655208.png" alt="image-20191224203655208" style="zoom:80%;" />

1. 用户发起连接请求，向RADIUS客户端发送用户名和口令
2. RADIUS客户端根据获取的用户名和口令，向RADIUS服务端发送认证请求
3. DADIUS服务端对用户名和口令进行鉴别。若正确，发送认证接受，若错误，返回认证拒绝(Access-Reject).认证接受中也包含了用户的授权信息
4. RADIUS客户端根据收到的结果允许或拒绝用户接入，如果允许，则向RADIUS服务器发送计费请求
5. RADIUS服务器返回计费开始响应，并开始计费。这时用户开始一个会话
6. 用户开始访问网络资源
7. 用户结束会话，请求断开连接
8. RADIUS客户端向RADIUS服务器发送计费停止请求
9. RADIUS服务器返回计费结束响应，并停止计费
10. RADIUS客户端通知用户会话关闭





#### 802.1X

基于端口的接入控制标准

<img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191224205626586.png" alt="image-20191224205626586" style="zoom:80%;" />

- 802.1X系统包含三个实体：客户端、设备端、和认证服务器

  - **客户端**

    请求接入局域网的用户终端

  - **设备端**

    控制用户接入的网络设备，并通过与认证服务器的交互来对所连接的用户进行认证

  - **认证服务器**

    用于对客户端进行认证、授权和计费，通常为RADIUS服务器

- 设备端为客户端提供的接入局域网的端口被划分为两种逻辑端口，受控端口和非受控端口

  - **非受控端口**

    始终处于双向连通状态，主要用来传递认证报文

  - **受控端口**

    在授权状态下处于双向连通状态，用于传递业务帧；在非授权状态下禁止从客户端接收数据

- **基于MD5-Challenge的EAP中继过程**

  <img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191224212337026.png" alt="image-20191224212337026" style="zoom:80%;" />

  1. 用户需要接入网络时，打开802.1X客户端程序，输入用户名和口令，发起连接请求
  2. 设备端接受到认证请求帧后，发出一个Identity类型 请求帧，要求用户的客户端程序输入用户名
  3. 客户端程序将用户名信息通过Identity类型的响应帧发送给设备端
  4. 设备端从客户端的响应帧中提取EAP报文并封装在RADIUS报文中发送给认证服务器
  5. RADIUS服务器收到转发的用户名信息后，将该信息与数据库中的用户名列表对比，找到该用户名对应的口令信息，用随机生成的一个MD5质询值对口令进行加密处理，生成鉴别码，同时将此MD5质询值通过RADIUS Access-Chanllenge报文发送给设备端
  6. 设备端将收到的MD5质询值转发给客户端
  7. 客户端利用收到的质询值对自己的口令以与RADIUS一样的方式生成鉴别码，将其放在报文中发送给设备端
  8. 设备端将收到的报文封装在RADIUS报文中发送给RADIUS服务器
  9. RADIUS服务器将收到的鉴别码和本地计算的鉴别码进行比较，如果相同，则认为该用户为合法用户，并向设备端发送认证通过报文
  10. 设备端收到认证通过报文后向客户端发送认证成功帧，并将端口状态改为授权状态，允许用户访问网络
  11. 用户在线期间，设备端会通过向客户端定期发送握手报文的方法，对用户的在线情况进行监测
  12. 若收到应答，表示用户仍然在线；若未收到应答，设备端会让用户下线，防止用户因为异常原因下线而无法感知
  13. 客户端发送EAPOL-Logoff帧给设备端，主动要求下线
  14. 设备端把端口从授权状态改为非授权状态，并向客户端发送EAP-Failure报文

- **基于CHAP的EAP终结方式认证过程**

  <img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191224214252990.png" alt="image-20191224214252990" style="zoom:80%;" />

  1. MD5质询值由设备端生成
  2. 由设备端把用户名、MD5质询值和客户端加密后的鉴别码一起发送给RADIUS服务器，实现相关的认证过程

- **基于MAC的接入控制方式**

  传统基于端口的接入控制方式只要一个用户下线，其他用户也会被拒绝使用网络，因此对控制方式进行了扩展，该方式下，端口下的所有接入用户需要进行单独认证





### 3、链路层的端口保护



#### MAC地址认证

- 一种基于端口和MAC地址对用户的访问权限进行控制的认证方法

- MAC地址可以远程实现或者本地实现：

  - **远程实现**

    需要用户某种认证协议的支持，如RADIUS服务器

- MAC地址使用的用户账户格式可以分为两种类型：

  - **MAC地址用户格式**

    使用用户的MAC地址作为认证时的用户名和口令，实现了MAC地址和交换机端口的特定的绑定关系

  - **固定用户名格式**

    所有用户均使用设备上指定的一个固定用户名和口令替代用户的MAC地址作为身份信息进行认证



#### 端口安全

- 端口安全（Port Security）是一种MAC地址过滤技术，基于MAC地址对网络接入进行安全控制

- **发出数据帧**

  保证只能发送到宿MAC地址被通过认证或被学习到的设备或主机，防止窃听网络报文

- **接收数据帧**

  只能接受源MAC地址被认证或被学习到的数据帧，否则视为非法数据帧

- 端口安全机制的另一个功能是对同时使用一个特定端口的MAC地址数量进行限制

- 可以防止CAM攻击和DHCP饥饿攻击



#### IP源保护

<img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191225140852453.png" alt="image-20191225140852453" style="zoom:80%;" />

- IP源保护(Ip Source Guard)功能用于对端口收到的IP报文进行过滤控制，通常配置在接入用户侧的端口上，防止非法报文通过

- IP源保护的绑定功能是针对交换机端口的

- **绑定表项**

  1. IP绑定表项
  2. MAC绑定表项
  3. IP+MAC绑定表项
  4. IP+VLAN绑定表项
  5. MAC+VLAN绑定表项
  6. IP+MAC+VLAN绑定表项

- **绑定表项生成**

  - 手工配置

    又称为静态配置，适用于局域网中主机较少的情况。保护全局静态绑定表项和端口静态绑定表项

    1. 全局静态绑定表项

       在设备上的所有端口生效

    2. 端口静态绑定表项

       仅在配置端口上生效

  - 动态获取

    通过获取其他模块生成的用户信息来生成绑定表项，例如：

    1. ARP窥探
    2. 802.1X
    3. DHCP窥探
    4. DHCP交互





### 4、ARP保护



#### ARP攻击防御

- **对无法解析的ARP请求的处理**

  - ARP抑制功能

    在一个时间窗口中，如果从某IP地址发来的ARP请求不能解析超过了设置的阈值，则在此时间窗口中将不再处理该IP发来的ARP请求

  - ARP黑洞路由

    当收到不能解析的ARP请求时，设备立即产生一个黑洞路由，并同时发动ARP主动探测，若在黑洞路由时间窗口中ARP解析成功，则设备马上删除黑洞路由并转发ARP请求，否则设备直接丢弃该报文。在删除黑洞路由之前，后续相同ARP请求将被丢弃

- **ARP报文源MAC地址一致性检查**

  将以太网数据帧首部的源MAC地址和ARP报文中的源MAC地址进行比较。若一致，转发，否则丢弃

- **ARP主动确认**

  设备在新建或更新ARP表项前进行主动确认（ARP探测），防止产生错误的ARP表项

- **授权ARP**

  在ARP动态学习中，只有与DHCP服务器生成的安全表项一致的ARP报文才能够被学习

- **ARP报文检测**

  1. 用户合法性检查
  2. ARP报文有效性检查
  3. ARP强制转发

- **ARP固化**

  将当前的ARP动态表项转换为静态表项，防止攻击者修改ARP表项





#### 窥探(Snooping)

<img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191225145727864.png" alt="image-20191225145727864" style="zoom:80%;" />

- 窥探功能为ARP和DHCP协议在正常交互中开启额外的安全处理，对数据进行集中管理，以增强其安全处理

- 当收到发送端IP地址和发送端MAC地址与已存在的ARP窥探表项IP地址和MAC均相同的ARP报文时，ARP报文表项更新，重新开始老化计时

- 为了使DHCP客户端能通过合法的DHCP服务器获取IP地址，DHCP窥探机制允许将设备端口设置为信任端口和不信任端口：

  - 信任端口

    正常转发收到的DHCP报文

  - 不信任端口

    接收到DHCP服务器响应的DHCP-ACK和DHCP-OFFER报文后，丢弃该报文

- 在DHCP窥探设备上指向DHCP服务器的端口需要设置为信任端口，其他端口设置为不信任端口





## 二、路由安全



### 1、路由的安全威胁



#### 威胁者

- **AS**

  通过发布特定的BGP路由信息来劫持或者影响正常的传输通路

- **黑客和犯罪组织**

  通过设法控制某个ISP的操作来实现的，威胁形式可能是路由劫持或服务失效攻击

- **IP地址注册管理机构**

  受到压力改变IP地址前辍持有者的信息，从而影响ISP对路由有效性的判定

- **某个国家或国家集团**

  可以控制本国的ISP来实施路由操控或者发起攻击



#### 威胁形式

- **主动窃听传输通路中的流量**

  攻击者通过路由劫持或路由泄露攻击来使传输通路经过自己，从而获取传输通路中的流量信息

- **对BGP路由器的攻击**

  - AS插入

    篡改路由信息中的传输通路信息，在其中添加指定的ASN使得传输通道经过该点，从而实现流量窃听和桥接攻击

  - 伪造路由源

    发布不属于自己的IP地址前辍的路由源信息，从而实现路由劫持或者服务失效

  - 安全通路降级

    攻击者通过篡改路由信息中的安全参数值，例如数字签名，使得安全机制失效；或修改构成传输通路的ASN序列，使得流量绕开某些节点

  - 失效通路通告

    攻击者可以回放某些已经失效的路由信息，以干扰其他节点构建正常的传输通路



### 2、RPKI

资源公钥基础设施(Resource Public Key Infrasturcture ,RPKI)表达了一种IP地址或ASN的可信层次结构，其目的是互联网中的某个实体(通常是BGP路由器)可以验证某个IP地址集或自治系统号ASN集宣称持有者对这个资源实际持有的合法性，从而支持安全的BGP路由消息交互



#### 基本模型

- RPKI包含三个部分：
  - 基于X.509标准的公钥基础设施(PKI)
  - 公钥证书之外由这个PKI使用的带有数字签名的对象，例如：路由源授权信息
  - 一个分布式存储系统
- **公钥证书**
  - RPKI中的公钥证书又称为资源证书(Resource Cerfiticate，RC)，是IP地址和ASN等互联网标识资源的归属有效性证明
  - 资源证书的作用实施证书颁发者通过该证书来证实响应的IP地址集和ASN集消息发布者的合法性，从而达到对某个主体发布某个BGP路由消息的有效性进行验证的目的

- **CA证书**

  用于证明资源持有的合法性，各级IP地址注册管理机构均需要持有RPKI的CA证书

- **路由源签证**

  <img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191225165640778.png" alt="image-20191225165640778" style="zoom:80%;" />

  1. 在对用户分配IP地址块时对这个地址块与用户标识进行数字签名以绑定这个持有关系，这个数字签名被称为路由源签证(Route Origin Attestation,ROA)，保存在RPKI的分布式存储系统中

- **路由源授权**

  <img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191225170545988.png" alt="image-20191225170545988" style="zoom:80%;" />

  1. 路由消息发布者通过数字签名生成路由源授权(Route Origination Authorizations，也记为ROA)信息
  2. 路由消息接收者使用相应的端系统证书来验证这个ROA信息的合法性
  3. 路由源授权信息证实了某个IP地址前辍的拥有者授权某个AS发布这个地址前辍的路由消息，即表明这个IP地址前辍在这个自治域中



#### 路由消息有效性的判定

pass



## 三、IPsec



### 1、IP协议的安全问题



#### 基本问题

- 鉴别机制缺失
- 机制滥用：恶意竞争



#### IPV4报头的安全性分析

<img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191225173212733.png" alt="image-20191225173212733" style="zoom:80%;" />

- **Toal length**

  攻击者可能会将此值最大化以消耗路由器内存。

- **Identification**

  如果该值是单调递增的，攻击者很容易推断发送报文的数量或进行隐身扫描。

- **Flags**

  攻击者可能会组成长度超过MTU但受本地网络支持的正常数据包，因此本地网关和NIDS都会记录这个流记录。然而由于长度超过MTU，因此会在某个位置被丢弃并返回ICMP错误报文，于是，这些监控设备认为端点在正常通信，但对端实际未收到任何数据，从而形成源端通信的假象

- **Fragment Offset**

  可能会发生重叠攻击；可能组成65532 +（65535 -20）= 131047bytes的数据包长度，与65535字节的正常最大长度冲突。

- **Option**

  1、源路由选项可能被滥用；
  2、可被用于栈溢出攻击

  3、路由警报选项需要慢速路径处理。故意设置此选项会降低报文的转发速率



#### IPv6报头的安全分析

<img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191225180256871.png" alt="image-20191225180256871" style="zoom:80%;" />

- **Flow Label**
  - 为了支持IP报文面向流的交换处理，提高转发效率
  - 流标记的使用可以分为有状态、无状态两种：
    1. 有状态：要求路由器建立流标记缓存，以识别不同的报文流
    2. 无状态：流记录按IPv4存储
  - 脆弱性：
    1. 流标签字段可能会受到影响，因为他不受IPsec保护
    2. 拒绝和盗窃服务：与有状态的流标签不同，无状态的流标签相同，带有源地址欺骗



#### 分段攻击

![image-20191225201243404](C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191225201243404.png)

攻击者将一个特定的内容分散在两个数据段中，并使其从分段部分重叠



#### 细小分段攻击

- **原理**

  宿(Destination)扩展项最多有264字节长，因此如果按8字节一段的方式对宿扩展进行分段，该扩展项可被分为33段，从而将高层协议挤到34段，而这个深度超过一般防火墙的检测范围

- **构造**

  1. Fragment 1: (Fragment offset = 0; length >= 16) 
  2. Fragment 2: (Fragment offset = 0; length = 8)
  3. Fragment 3: (Fragment offset >= 2; length = rest of message)



### 2、IPsec概述



#### 基本功能

- IPsec的安全功能由下面两部分提供：
  - 安全规程
    1. 鉴别头AH（Authentication Header）
    2. 负载安全封装ESP（Encapsulating Security Payload）
  - 密钥管理协议IKEv2（Internet Key Exchange Protocol Version2）

#### 服务方式

- **安全规程的工作模式**

  <img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191225205313124.png" alt="image-20191225205313124" style="zoom:80%;" />

  - **传输模式**

    提供上层协议内容的安全保护

  - **隧道模式**

    提供IP报文的隧道保护

    

- **IPsec的基本服务方式**

  <img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191225205602772.png" alt="image-20191225205602772" style="zoom:80%;" />

  1. AH提供无连接的完整性保护，数据源鉴别和可选择的防回放服务
  2. ESP规程提供加密，流量控制
  3. ESP规程必须实现，AH规程可选实现



#### 实现方式

- **把IPsec集成在现有的IP实现中**

  适用于主机和网关软件实现，需要能够修改现有IP实现的源码

- **Bump-in-the-Stack(BITS)**

  将IPsec实现在已有的IP协议栈之下，存在于IP协议栈和网络驱动软件之间

- **Bump-in-the-wire(BITW)**

  将IPsec实现在独立的加密机中，从而在两个路由器或主机直接按形成安全隧道，不需要修改IP源码





### 3、IPsec数据库

<img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\image-20191227211402062.png" alt="image-20191227211402062" style="zoom:80%;" />

- IPsec有三个名义上的数据库：

  - 安全策略库**SPD**

    存放定义的各种安全策略，以确定如何分解达到和离去的IP流量

  - 安全联系库**SAD**

    保存已建立的各个安全联系的各种参数，IPsec的安全规程将根据这些参数来处理受保护的IP报文

  - 对等授权库**PAD**

    提供安全联系管理协议与SPD之间的关

#### SPD

- 主要内容为选择符是(适用于谁)和处理要求(怎么做)

- 从逻辑上分为三部分：

  - SPD-S(secure traffic)

    定义所有索要IPSec安全机制保护的IP地址范围

  - SPD-O(outbound)

    定义所有离去流量中需要旁路(忽略IPsec保护)或丢弃的IP地址范围

  - SPD-I(inbound)

    定义所有进入流量中需要旁路或丢弃的IP地址范围

- 每个策略均包括选择符selector，用于定义SA的流量集，安全策略选择符至少要包含下列之一：

  - **远地IP地址(IPv4/IPv6)**

    这是一个地址范围表，其内容可以是一个IP地址，一个IP地址列表，或者由一组IP地址范围构成的表

  - **本地地址（IPv4/IPv6)**

    形同远地地址

  - **上一层协议**

    其内容从IPv4报头的protocol字段或IPv6报头的Protocol字段获得，其值还可以是any

  - **Name**

    是一种特殊的选择符，其值不能从IP报文中直接获得，通常是本地或远地的符号表示

#### SAD

- 已创建的安全联系存放在安全联系库SAD中，每个安全联系为一项，表项中存放这个安全联系的参数。
- SAD Entry:
  - 基本参数
  - 密码学参数
  - 传输参数
  - 标记参数
- 安全联系如果超过生存期则必须重置，及更新参数并改变SPI
- 查找的顺序
  - 首先按照SPI、源地址、和宿地址的组合查找匹配项；
  - 若找不到，再按SPI和宿地址的组合查找匹配项
  - 若还找不到，如果端系统的SPI值空间是唯一的，则只按SPI查找匹配项，否则按SPI与规程的组合查找匹配项
  - 如果找到匹配，则按匹配项的要求处理收到的报文，否则，丢弃报文



#### PAD

提供网络中的特定对等实体(例如两个主机)或对等实体组(例如两个IP地址前辍)与SPD中的某个安全策略之间联系的描述，每个描述称为一个表项

