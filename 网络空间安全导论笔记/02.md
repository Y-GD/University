# 第三章	僵尸网络



## 一、网络蠕虫



### 1、基本概念

#### Covet Code

在用户不知道的情况下安装的代码



#### Malware

恶意软件。一种代码，脚本，活动内容或其他软件，用于破坏计算机操作，收集敏感信息或获得对私有计算机系统的访问权限。



#### Malicious Code

- 恶意代码。病毒，蠕虫，特洛伊木马，间谍软件等。
- 恶意代码是指故意编制或设置的，对网络或系统会产生威胁或潜在威胁的计算机代码





### 2、蠕虫与病毒

#### 蠕虫

计算机蠕虫是可以独立运行，并能把自身的一个包含所有功能的版本传播到另外的计算机上的程序



#### 病毒

计算机病毒是一段代码，能把自身加载到其他程序包括操作系统上。它不能独立运行，需要由它的宿主程序运行来激活它



#### 相同点

- 计算机蠕虫和计算机病毒都具有传染性和复制功能





### 3、Morris 蠕虫

#### Morris蠕虫的工作机制



<img src="C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\1570591531829.png" alt="1570591531829"  />

- 蠕虫程序的工作流程一般可以分为扫描、攻击、现场处理和复制等四部分组成
- 当扫描到有漏洞的计算机系统后，蠕虫就对其进行攻击，攻击流程部分完成后完成蠕虫主体的迁移工作
- 蠕虫的迁移通常先将一段引导代码送入到被攻击的系统，然后通过执行这个引导程序来将攻击代码主体送入被攻击系统
- 攻击方式：
  - rsh攻击
  - sendmail攻击
  - fingerd攻击





#### Morris蠕虫的存活机制

**生存竞争**

- 蠕虫只有完成自己的工作才会终止自身的运行
- 每N次竞争中，有一次不管结果如何，一律让蠕虫存活（N=7）

**竞争**

- 定期复制自己
- 更改进程号以更好的隐藏
- 在系统中保持调度优先级
- 当蠕虫运行超过12小时时，它将清除其感染列表的状态，以便所有的目标将再次被感染



#### Morris蠕虫的特点

**渗透能力强**

- 创建和使用系统漏洞
- 通过扫描查找新目标
- 将攻击代码分为较小的引导程序和较大的主体

**其他**

- 密码窃取功能将蠕虫变成了DoS攻击
- 没有远程控制能力
- 环境依赖性：在目标系统中需要C编译器



### 4、蠕虫的技术特征

#### 蠕虫的行为特征

- **主动传播**

  与病毒区别最大的一点

- 行踪隐蔽

- **利用漏洞**

  计算机系统存在漏洞是蠕虫传播的前提

- 造成网络拥塞

- 降低系统性能

- 产生安全隐患

- 反复性



#### 蠕虫的结构特征

蠕虫程序功能结构模型

- **基本功能模块**
  - 搜索模块
  - 攻击模块
  - 传输模块
  - 信息搜集模块
  - 繁殖模块
- **扩展功能模块**
  - 通信模块
  - 隐藏模块
  - 破坏模块
  - 控制模块



### 5、蠕虫的高级实现技术

- 动态个体技术
- 动态功能升级技术
- 蠕虫网络通信技术
- 隐身技术
- 与环境结合能力
- 巨型蠕虫
- 分布式蠕虫
- 蠕虫自动编写机



## 二、僵尸网络



### 1、基本概念

#### 僵尸网络

- 由僵尸程序构成的网络
- 攻击者隐秘地传播僵尸程序，恶意控制大量主机，并通过命令与控制信道（C&C Channel,$C_2$信道）协调运行的网络
- $C_2$信道是僵尸网络有别于网络蠕虫的最重要特征



#### 僵尸网络的威胁

**按照处理过程划分**

- 信息散布
- 信息收集
- 信息处理

**按照获取经济力利益的方式划分**

- 个人隐私数据的获取
- 僵尸网络租赁服务
- 挖矿
- 勒索



### 2、基本结构



#### 僵尸网络的典型结构

- **僵尸**

  在业界被称为“肉鸡”，是被僵尸程序控制的设备。这些设备可以是任意类型。比如PC、移动电话、物联网设备等等

- **僵尸控制器（C2控制器）**

  僵尸网络控制者的代理，负责僵尸网络的维护、更新、发布各种C2命令等

- **跳板设备（Stepping Stone)**

  攻击者用于隐藏自身和C2服务器的控制信道中继服务器

- **僵尸网络控制者**

  真正控制整个僵尸网络的人或者组织，负责扩展和维护僵尸网络规模，更新僵尸程序功能，直接或间接组织网络攻击。

![1570614358518](C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\1570614358518.png)



#### 僵尸网络的工作过程

![1570614498485](C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\1570614498485.png)

1. 僵尸网络通过各种方式传播僵尸程序
2. 通过代码服务器下载僵尸程序，主机被感染
3. 通过DNS服务器查询到僵尸网络控制器的IP地址后，于僵尸网络控制器连接，加入僵尸网络
4. 僵尸程序于僵尸控制器之间，攻击者与僵尸控制器之间进行C&C通信
5. 僵尸程序接受或主动获取命令发起攻击活动



### 3、生命周期模型

![1570614431134](C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\1570614431134.png)

- 僵尸网络大致总是处在活跃、隔离和死亡状态
- **活跃状态**
  - 持续倾听或周期性倾听网络控制器发出的指令
  - 指令分为繁殖指令和攻击指令两类
- **隔离状态**
  - 僵尸节点因其宿主机离线而不可达，则这个节点进入隔离阶段
- **死亡阶段**
  - 一个僵尸网络进入死亡阶段通常意味着其控制器不可用了



## 三、僵尸网络的组成结构



### 1、僵尸网络的结构特征

- **直接控制结构**
  - IRC、HTTP两类协议是典型的集中式$C_2$信道
  - 基于即时通信软件(MSN)也可归为集中式
- **P2P结构**
  - 所有节点之间的关系对等
- **无结构型**
  - 每个僵尸节点不知道任何其他的僵尸节点的信息，每次通信都是通过扫描对端完成的
- **基于代理的控制结构**
  - 混合型P2P僵尸网络最突出的特点是层次化结构。



#### C2服务器访问的方式

- IP地址
- 域名
- 云平台和社交网站



### 2、僵尸程序的典型结构



#### 僵尸程序代码组成

- **执行环境检测部分**

  用于检测所处环境是否处于受控环境，即处于沙盒或者类似的受控分析检测环境，如果是这样的话，僵尸程序协议停止活动以逃避检测和动态分析

- **命令执行部分**

  完成与控制器的交互和信息传输，维持与控制器的联系，控制自身的活性，完成繁殖任务和控制器要求的攻击任务

- **攻击部分**

  包含各个预设的攻击能力的相应代码





#### 加壳（packing)与脱壳(unpacking)

![1570624356092](C:\Users\杨士伟\AppData\Roaming\Typora\typora-user-images\1570624356092.png)

- **stub**

  脱壳时使用的桩代码，实际上就是解压缩程序

- **细粒度加壳模型**

  以较小的内存区域为单位实现加壳，基本原则是消除内存中存在可执行程序完整映像的时刻，增加程序逆向工程分析的难度



## 四、Fast-Flux生存机制

为了躲避网络防御方对C2控制器的检测与拦截，僵尸网络使用了快速变化其C2控制器标识和位置的方法来提高生存能力。



### 1、IP fluxing机制

- A记录（描述一个域名和一个IP地址的绑定关系）的生存期（TTL）特别短

- 域名同时指向多个IP地址

- **Single flux**
  

C2控制器的域名保持不变，解析IP地址在不断变化

- **Double flux**
  
  C2控制器的ip和提供解析的DNS服务器都在不断变化



### 2、Domain fluxing机制

- 采用DGA算法应对域名屏蔽
- 僵尸网路在$C_2$控制器端通过DGA算法生成域名列表，挑选其中的域名进行注册，僵尸程序按序从域名列表的域名进行解析尝试
- 一段时间域名发生变化后，僵尸程序重新按照域名列表进行解析尝试





